[{'../../types/reports': 'mport { formatCurrencyCLP', './report-data-aggregator': 'mport { parseISO'}, {'font': {'bold': True, 'color': {'rgb': 'FFFFFF'}}, 'fill': {'fgColor': {'rgb': '15803d'}}, 'alignment': {'horizontal': 'center'}}, {'font': {'bold': True, 'color': {'rgb': 'FFFFFF'}}, 'fill': {'fgColor': {'rgb': '14532d'}}, 'alignment': {'horizontal': 'center'}}, {'fill': {'fgColor': {'rgb': 'f9fafb'}}, 'top': {'style': 'thin'}, 'bottom': {'style': 'thin'}, 'left': {'style': 'thin'}, 'right': {'style': 'thin'}}, {'font': {'bold': True}, 'fill': {'fgColor': {'rgb': 'ecfccb'}}, 'border': {'top': {'style': 'double'}, 'bottom': {'style': 'double'}}}, {'Tayasal - Informe de Producción': {'origin': 'A1'}, 'font': {'bold': True, 'size': 16, 'color': {'rgb': '15803d'}}, 'alignment': {'horizontal': 'center'}}, {'origin': 'A2'}, ['A2'], {'font': {'sz': 12}}, [[]], {'origin': 'A3'}, ['Métrica', 'Valor'], ['metricsHeaders], { origin: \'A5\' })\n  // Ensure cells exist before setting styles\n  if (!ws[\'A5\']) ws[\'A5\'] = { v: metricsHeaders[0], t: \'s\' }\n  if (!ws[\'B5\']) ws[\'B5\'] = { v: metricsHeaders[1], t: \'s\' }\n  ws[\'A5\'].s = GREEN_HEADER\n  ws[\'B5\'].s = GREEN_HEADER\n\n  // Metrics rows\n  const metrics = [\n    [\'Órdenes de Producción\', data.summary.totalOrders],\n    [\'Bloques Producidos\', data.summary.totalBlocks],\n    [\'Costo Total\', formatCurrencyCLP(data.summary.totalCost)],\n    [\'Costo Promedio por Bloque\', formatCurrencyCLP(data.summary.avgCostPerBlock)],\n    [\n      \'Bloques por Hora\',\n      data.summary.blocksPerHour.toFixed(2),\n    ],\n    [\'Tipo de Bloque Más Producido\', data.summary.topBlockType],\n  ]\n\n  XLSX.utils.sheet_add_aoa(ws, metrics, { origin: \'A6\' })\n\n  // Apply alternating rows and borders for metrics\n  for (let i = 0; i < metrics.length; i++) {\n    const rowIdx = 6 + i\n    const isAlt = i % 2 === 1\n    // Ensure cells exist before setting styles\n    if (!ws[`A${rowIdx}`]) ws[`A${rowIdx}`] = { v: metrics[i][0], t: \'s\' }\n    if (!ws[`B${rowIdx}`]) ws[`B${rowIdx}`] = { v: metrics[i][1], t: \'s\' }\n    if (isAlt) {\n      ws[`A${rowIdx}`].s = ALTERNATE_ROW\n      ws[`B${rowIdx}`].s = ALTERNATE_ROW\n    }\n    ws[`A${rowIdx}`].s = {\n      ...ws[`A${rowIdx}`].s,\n      border: BORDER_STYLE,\n    }\n    ws[`B${rowIdx}`].s = {\n      ...ws[`B${rowIdx}`].s,\n      border: BORDER_STYLE,\n    }\n  }\n\n  // Set column widths\n  ws[\'!cols\'] = [\n    { wch: 30 }, // Column A\n    { wch: 20 }, // Column B\n  ]\n\n  // Merge title cells\n  if (!ws[\'!merges\']) ws[\'!merges\'] = []\n  ws[\'!merges\'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 1 } })\n  ws[\'!merges\'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 1 } })\n\n  workbook.SheetNames.push(\'Resumen\')\n  workbook.Sheets[\'Resumen\'] = ws\n}\n\n/**\n * Creates the orders detail sheet.\n */\nfunction buildOrdersSheet(workbook: XLSX.WorkBook, data: ReportData): void {\n  const ws = XLSX.utils.aoa_to_sheet([])\n\n  // Title\n  XLSX.utils.sheet_add_aoa(ws, [[\'Órdenes de Producción\']], { origin: \'A1\' })\n  ws[\'A1\'].s = {\n    font: { bold: true, size: 16, color: { rgb: \'15803d\' } },\n    alignment: { horizontal: \'center\' },\n  }\n\n  // Spacer\n  XLSX.utils.sheet_add_aoa(ws, [[\'\']], { origin: \'A2\' })\n\n  // Headers\n  const headers = [\n    \'ID\',\n    \'Fecha\',\n    \'Tipo\',\n    \'Cantidad\',\n    \'Estado\',\n    \'Materiales\',\n    \'Mano Obra\',\n    \'Equipo\',\n    \'Total\',\n    \'Operario\',\n  ]\n  XLSX.utils.sheet_add_aoa(ws, [headers], { origin: \'A4\' })\n  headers.forEach((_, idx) => {\n    const cellRef = XLSX.utils.encode_cell({ r: 3, c: idx })\n    // Ensure cell exists before setting style\n    if (!ws[cellRef]) ws[cellRef] = { v: headers[idx], t: \'s\' }\n    ws[cellRef].s = DARK_GREEN_HEADER\n  })\n\n  // Data rows\n  const rows: any[][] = []\n  data.orders.forEach((order) => {\n    rows.push([\n      order.id,\n      formatDateES(parseISO(order.createdAt)),\n      order.block_type,\n      order.quantity_produced,\n      order.status,\n      formatCurrencyCLP(order.material_cost),\n      formatCurrencyCLP(order.labor_cost),\n      formatCurrencyCLP(order.equipment_cost),\n      formatCurrencyCLP(order.total_cost),\n      order.created_by_name,\n    ])\n  })\n\n  XLSX.utils.sheet_add_aoa(ws, rows, { origin: \'A5\' })\n\n  // Apply alternating rows and borders\n  rows.forEach((_, i) => {\n    const rowIdx = 4 + i + 1 // +1 because we started at A5\n    const isAlt = i % 2 === 1\n    if (isAlt) {\n      for (let c = 0; c < headers.length; c++) {\n        const cellRef = XLSX.utils.encode_cell({ r: rowIdx - 1, c })\n        if (!ws[cellRef]) ws[cellRef] = { v: \'\', t: \'s\' }\n        ws[cellRef].s = ALTERNATE_ROW\n      }\n    }\n    // Add borders to all cells\n    for (let c = 0; c < headers.length; c++) {\n      const cellRef = XLSX.utils.encode_cell({ r: rowIdx - 1, c })\n      if (!ws[cellRef]) ws[cellRef] = { v: \'\', t: \'s\' }\n      ws[cellRef].s = {\n        ...ws[cellRef].s,\n        border: BORDER_STYLE,\n      }\n    }\n  })\n\n  // Set column widths\n  ws[\'!cols\'] = [\n    { wch: 12 }, // ID\n    { wch: 12 }, // Fecha\n    { wch: 15 }, // Tipo\n    { wch: 10 }, // Cantidad\n    { wch: 12 }, // Estado\n    { wch: 14 }, // Materiales\n    { wch: 12 }, // Mano Obra\n    { wch: 10 }, // Equipo\n    { wch: 12 }, // Total\n    { wch: 15 }, // Operario\n  ]\n\n  workbook.SheetNames.push(\'Órdenes\')\n  workbook.Sheets[\'Órdenes\'] = ws\n}\n\n/**\n * Creates the costs breakdown sheet.\n */\nfunction buildCostsSheet(workbook: XLSX.WorkBook, data: ReportData): void {\n  const ws = XLSX.utils.aoa_to_sheet([])\n\n  // Title\n  XLSX.utils.sheet_add_aoa(ws, [[\'Análisis de Costos\']], { origin: \'A1\' })\n  ws[\'A1\'].s = {\n    font: { bold: true, size: 16, color: { rgb: \'15803d\' } },\n    alignment: { horizontal: \'center\' },\n  }\n\n  // Spacer\n  XLSX.utils.sheet_add_aoa(ws, [[\'\']], { origin: \'A2\' })\n\n  // Headers\n  const headers = [\'Categoría\', \'Monto (CLP)\', \'% del Total\']\n  XLSX.utils.sheet_add_aoa(ws, [headers], { origin: \'A4\' })\n  headers.forEach((_, idx) => {\n    const cellRef = XLSX.utils.encode_cell({ r: 3, c: idx })\n    // Ensure cell exists before setting style\n    if (!ws[cellRef]) ws[cellRef] = { v: headers[idx], t: \'s\' }\n    ws[cellRef].s = GREEN_HEADER\n  })\n\n  // Calculate total\n  const total =\n    data.costsByCategory.materials +\n    data.costsByCategory.labor +\n    data.costsByCategory.equipment +\n    data.costsByCategory.energy +\n    data.costsByCategory.maintenance\n\n  // Data rows\n  const categories = [\n    [\'Materiales\', data.costsByCategory.materials],\n    [\'Mano de Obra\', data.costsByCategory.labor],\n    [\'Equipo\', data.costsByCategory.equipment],\n    [\'Energía\', data.costsByCategory.energy],\n    [\'Mantenimiento\', data.costsByCategory.maintenance],\n  ]\n\n  XLSX.utils.sheet_add_aoa(ws, categories, { origin: \'A5\' })\n\n  // Apply formatting and calculate percentages\n  categories.forEach((cat, i) => {\n    const rowIdx = 4 + i + 1\n    // Ensure cells exist before setting styles\n    if (!ws[`A${rowIdx}`]) ws[`A${rowIdx}`] = { v: cat[0], t: \'s\' }\n    if (!ws[`B${rowIdx}`]) ws[`B${rowIdx}`] = { v: cat[1], t: \'s\' }\n    if (!ws[`C${rowIdx}`]) ws[`C${rowIdx}`] = { v: 0, t: \'n\' }\n    \n    const cellA = ws[`A${rowIdx}`]\n    const cellB = ws[`B${rowIdx}`]\n    const cellC = ws[`C${rowIdx}`]\n\n    cellA.s = { ...cellA?.s, border: BORDER_STYLE }\n    cellB.s = {\n      ...cellB?.s,\n      border: BORDER_STYLE,\n      numFmt: \'"$', 0, ", // CLP format approximation\n    }\n    cellC.s = {\n      ...cellC?.s,\n      border: BORDER_STYLE,\n      numFmt: '0.00%"], [1], ['C${rowIdx}`].v = percentage\n    ws[`C${rowIdx}`].t = \'n\'\n  })\n\n  // Total row\n  const totalRowIdx = 4 + categories.length + 1\n  XLSX.utils.sheet_add_aoa(ws, [[\'TOTAL\', total, 1]], { origin: `A${totalRowIdx}` })\n  // Ensure total row cells exist\n  if (!ws[`A${totalRowIdx}`]) ws[`A${totalRowIdx}`] = { v: \'TOTAL\', t: \'s\' }\n  if (!ws[`B${totalRowIdx}`]) ws[`B${totalRowIdx}`] = { v: total, t: \'s\' }\n  if (!ws[`C${totalRowIdx}`]) ws[`C${totalRowIdx}`] = { v: 1, t: \'n\' }\n  \n  const totalCellA = ws[`A${totalRowIdx}`]\n  const totalCellB = ws[`B${totalRowIdx}`]\n  const totalCellC = ws[`C${totalRowIdx}`]\n\n  totalCellA.s = {\n    ...TOTAL_ROW.border,\n    font: { bold: true },\n    fill: { fgColor: { rgb: \'ecfccb\' } },\n  }\n  totalCellB.s = {\n    ...TOTAL_ROW.border,\n    font: { bold: true },\n    numFmt: \'"$', 0, ",\n  }\n  totalCellC.s = {\n    ...TOTAL_ROW.border,\n    font: { bold: true },\n    numFmt: '0.00%"], ['!merges'], ['!merges'], [], ['!merges'], {'s': {'r': 'totalRowIdx - 1', 'c': 0}, 'e': {'r': 'totalRowIdx - 1', 'c': 1}}, ['!cols'], [{'wch': 20}, {'wch': 18}, {'wch': 12}], ['Costos'], {'Impacto en Inventario': {'origin': 'A1'}, 'font': {'bold': True, 'size': 16, 'color': {'rgb': '15803d'}}, 'alignment': {'horizontal': 'center'}}, [[]], {'origin': 'A2'}, ['Material', 'Unidad', 'Stock Inicial', 'Consumo', 'Stock Final', 'Costo Unit.', 'Valor Final'], ['headers], { origin: \'A4\' })\n  headers.forEach((_, idx) => {\n    const cellRef = XLSX.utils.encode_cell({ r: 3, c: idx })\n    // Ensure cell exists before setting style\n    if (!ws[cellRef]) ws[cellRef] = { v: headers[idx], t: \'s\' }\n    ws[cellRef].s = GREEN_HEADER\n  })\n\n  // Data rows\n  const rows: any[][] = data.inventoryChanges!.map((inv) => [\n    inv.materialName,\n    inv.unit,\n    inv.stockInitial,\n    inv.quantityUsed,\n    inv.stockFinal,\n    inv.unitCost,\n    inv.totalValue,\n  ])\n\n  XLSX.utils.sheet_add_aoa(ws, rows, { origin: \'A5\' })\n\n  // Apply borders and number formatting\n  rows.forEach((_, i) => {\n    const rowIdx = 4 + i + 1\n    for (let c = 0; c < headers.length; c++) {\n    const cellRef = XLSX.utils.encode_cell({ r: rowIdx - 1, c })\n      if (!ws[cellRef]) ws[cellRef] = { v: \'\', t: \'s\' }\n      ws[cellRef].s = {\n        ...ws[cellRef].s,\n        border: BORDER_STYLE,\n      }\n    }\n\n    // Numeric columns: Stock Initial, Consumo, Stock Final, Unit Cost, Total Value\n    const numericCols = [2, 3, 4, 5, 6]\n    numericCols.forEach((c) => {\n      const cellRef = XLSX.utils.encode_cell({ r: rowIdx - 1, c })\n      ws[cellRef].s = {\n        ...ws[cellRef].s,\n        numFmt: \'"$', 0, ",\n      }\n    })\n  })\n\n  // Total row\n  const totalConsumption = data.inventoryChanges!.reduce(\n    (sum, inv) => sum + inv.quantityUsed,\n    0\n  )\n  const totalValue = data.inventoryChanges!.reduce(\n    (sum, inv) => sum + inv.totalValue,\n    0\n  )\n  const totalRowIdx = 4 + rows.length + 1\n  XLSX.utils.sheet_add_aoa(ws, [['TOTAL", ', totalConsumption,', ", '"], {'origin': 'A${totalRowIdx'}, ["A${totalRowIdx}`]) ws[`A${totalRowIdx}`] = { v: 'TOTAL', t: 's' }\n  if (!ws[`C${totalRowIdx}`]) ws[`C${totalRowIdx}`] = { v: totalConsumption, t: 's' }\n  if (!ws[`F${totalRowIdx}`]) ws[`F${totalRowIdx}`] = { v: totalValue, t: 's' }\n\n  // Style total row\n  for (let c = 0; c < headers.length; c++) {\n    const cellRef = XLSX.utils.encode_cell({ r: totalRowIdx - 1, c })\n    ws[cellRef].s = {\n      ...TOTAL_ROW,\n      border: {\n        top: { style: 'double' },\n        bottom: { style: 'double' },\n      },\n    }\n  }\n\n  // Columns\n  ws['!cols'] = [\n    { wch: 20 },\n    { wch: 10 },\n    { wch: 14 },\n    { wch: 12 },\n    { wch: 14 },\n    { wch: 12 },\n    { wch: 16 },\n  ]\n\n  workbook.SheetNames.push('Inventario')\n  workbook.Sheets['Inventario'] = ws\n}\n\n// ============================================================================\n// Main Export Function\n// ============================================================================\n\n/**\n * Generates an Excel file from report data and triggers download.\n */\nexport function exportToExcel(data: ReportData): void {\n  try {\n    // Create workbook\n    const workbook: XLSX.WorkBook = { SheetNames: [], Sheets: {} }\n\n    // Build requested sheets\n    buildSummarySheet(workbook, data)\n    buildOrdersSheet(workbook, data)\n    buildCostsSheet(workbook, data)\n    buildInventorySheet(workbook, data)\n\n    // Generate filename\n    const now = new Date()\n    const dateStamp = now.getFullYear().toString() +\n      (now.getMonth() + 1).toString().padStart(2, '0') +\n      now.getDate().toString().padStart(2, '0')\n    const cycleType = data.period.start.toISOString().slice(0, 7) // YYYY-MM\n    const filename = `Tayasal_Produccion_${dateStamp}_ciclo_${cycleType}.xlsx`\n\n    // Write to binary string\n    const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' })\n\n    // Convert to Blob and download\n    const blob = new Blob([s2ab(wbout)], {\n      type:\n        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8',\n    })\n\n    downloadFile(blob, filename)\n  } catch (error) {\n    console.error('Error exporting to Excel:', error)\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred during export'\n    throw new Error(`Failed to export Excel file: ${errorMessage}`)\n  }\n}\n\n/**\n * Helper: String to ArrayBuffer conversion for Excel binary output.\n */\nfunction s2ab(s: string): ArrayBuffer {\n  const buf = new ArrayBuffer(s.length)\n  const view = new Uint8Array(buf)\n  for (let i = 0; i < s.length; i++) {\n    view[i] = s.charCodeAt(i) & 0xff\n  }\n  return buf\n}\n\n/**\n * Helper: Triggers file download via anchor element.\n */\nfunction downloadFile(blob: Blob, filename: string): void {\n  const url = URL.createObjectURL(blob)\n  const link = document.createElement('a')\n  link.href = url\n  link.download = filename\n  document.body.appendChild(link)\n  link.click()\n  document.body.removeChild(link)\n  URL.revokeObjectURL(url)\n}\n\n// ============================================================================\n// Formatting Helpers\n// ============================================================================\n\nexport { formatCurrencyCLP, formatDateES }"]]